<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projekt-Board</title>
  <style>
    :root{
      --border:#e6e8eb; --bg:#f5f6f8; --text:#111;
      --sidebar-min:200px; --sidebar-ideal:22vw; --sidebar-max:25vw;
      --muted:#5f6770;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; }
    body{
      display:flex; height:100vh; background:var(--bg); color:var(--text);
      font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    /* Sidebar */
    .sidebar{
      background:#fff; border-right:1px solid var(--border);
      flex:0 0 clamp(var(--sidebar-min), var(--sidebar-ideal), var(--sidebar-max));
      display:flex; flex-direction:column; min-width:var(--sidebar-min);
    }
    .section{
      display:flex; flex-direction:column; gap:8px; padding:12px 10px;
      border-bottom:1px solid var(--border);
    }
    .section h3{ font-size:13px; font-weight:700; color:#2a2f36; letter-spacing:.3px; }
    .list{ list-style:none; max-height:35vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:9px 10px; border-bottom:1px solid #f1f3f5; background:#fff;
    }
    .row:last-child{ border-bottom:0; }
    .row button.main{
      flex:1; text-align:left; border:0; background:transparent; padding:0; cursor:pointer; font:inherit;
    }
    .row.active{ background:#eef6ff; }
    .icons{ display:flex; gap:4px; }
    .icon-btn{
      border:1px solid var(--border); background:#fff; border-radius:7px; padding:4px 6px; cursor:pointer; font-size:12px;
    }
    .icon-btn:hover{ background:#f7f7f9; }
    .toolbar{ display:flex; gap:8px; }
    .toolbar input, .btn{
      padding:8px 10px; font:inherit; border:1px solid var(--border); background:#fff; border-radius:8px;
    }
    .btn{ cursor:pointer; }
    .btn:hover{ background:#f7f7f9; }

    .hint{ color:var(--muted); font-size:12px; padding:0 2px; }

    /* Content */
    .content{
      flex:1; margin:20px; background:#fff; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.07); display:flex; flex-direction:column; overflow:hidden;
    }
    .content-header{
      padding:10px 12px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .left{ display:flex; gap:12px; align-items:center; }
    .chip{ font-size:12px; padding:4px 8px; background:#f3f4f7; border-radius:999px; }
    .controls{ display:flex; gap:8px; align-items:center; }
    .status{ font-size:12px; color:#666; }
    .hidden{ display:none; }

    /* Canvas */
    .canvas-wrap{ position:relative; flex:1; overflow:auto; background:#fafafa; }
    .canvas{
      position:relative; margin:16px auto; width:min(1200px,95%); min-height:600px;
      background:#fff; border:1px solid #eef0f2; box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .bgimg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }

    /* Boxen */
    .box{
      position:absolute; border:2px dashed #3333; background:rgba(255,204,0,.25); cursor:move; outline:0;
    }

    /* Drag & Drop Hinweise */
    .droptarget{ outline:2px dashed #8ab6ff; outline-offset:-2px; }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <!-- Ordner -->
    <div class="section">
      <h3>Ordner</h3>
      <ul id="folderList" class="list" aria-label="Ordnerliste"></ul>
      <div class="toolbar">
        <input id="newFolderName" type="text" placeholder="Neuer Ordner‚Ä¶" />
        <button id="addFolderBtn" class="btn">Anlegen</button>
      </div>
      <div class="hint">Tipp: Ziehe Projekte auf einen Ordner, um sie zu verschieben.</div>
    </div>

    <!-- Projekte -->
    <div class="section" style="border-bottom:none">
      <h3>Projekte</h3>
      <ul id="projList" class="list" aria-label="Projektliste"></ul>
      <div class="toolbar">
        <input id="newName" type="text" placeholder="Neues Projekt‚Ä¶" />
        <button id="addBtn" class="btn">Anlegen</button>
      </div>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="content">
    <div class="content-header">
      <div class="left">
        <div id="title" class="chip">Kein Projekt gew√§hlt</div>
        <div class="controls">
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="bgBtn" class="btn">Hintergrundbild</button>
          <button id="addBoxBtn" class="btn">K√§stchen hinzuf√ºgen</button>
          <input id="colorPicker" type="color" value="#ffcc00" title="K√§stchenfarbe" />
          <button id="saveBtn" class="btn">Speichern</button>
        </div>
      </div>
      <div id="status" class="status">‚Äì</div>
    </div>

    <div class="canvas-wrap">
      <div id="canvas" class="canvas">
        <img id="bg" class="bgimg hidden" alt="" />
      </div>
    </div>
  </main>

  <!-- APP -->
  <script type="module">
    /* Firebase SDKs */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* Deine Config */
    const firebaseConfig = {
      apiKey: "AIzaSyADlFNneC4KlLpKc5VsCu6cD2HBI9nqeFg",
      authDomain: "aktionen-1a5c9.firebaseapp.com",
      projectId: "aktionen-1a5c9",
      storageBucket: "aktionen-1a5c9.appspot.com",
      messagingSenderId: "102987694659",
      appId: "1:102987694659:web:066654dba83f4021e7caf6",
      measurementId: "G-NHLWNGVTGM"
    };

    /* Init */
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const storage = getStorage(app);

    /* DOM */
    const $ = (id)=>document.getElementById(id);
    const folderList = $('folderList');
    const projList   = $('projList');
    const titleEl    = $('title');
    const statusEl   = $('status');
    const canvas     = $('canvas');
    const bg         = $('bg');
    const fileInput  = $('fileInput');
    const colorPicker= $('colorPicker');

    /* State */
    const LAST_KEY = 'lastProjectId';
    const SAVE_DEBOUNCE_MS = 600;

    let folders = [];            // [{id,name}]
    let allProjects = [];        // [{id,name,folderId,bgUrl,boxes}]
    let currentFolderId = null;  // null = Alle
    let current = null;          // aktives Projekt {id,name}
    let boxes = [];
    let bgUrl = "";
    let saveTimer = null;

    const status = (t)=> statusEl.textContent = t;

    /* ===== Helpers ===== */
    const slug = s => (s||'').toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'') || String(Date.now());
    const hexToRGBA = (hex, a)=>{
      const v = hex.replace('#',''); const r=parseInt(v.slice(0,2),16), g=parseInt(v.slice(2,4),16), b=parseInt(v.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    };

    function scheduleSave(){
      if(!current) return;
      clearTimeout(saveTimer);
      status('Speichern‚Ä¶');
      saveTimer = setTimeout(async ()=>{
        await setDoc(doc(db,'projects',current.id), {
          name: current.name, folderId: current.folderId || null,
          bgUrl, boxes, updatedAt: Date.now()
        }, { merge:true });
        status('Gespeichert');
      }, SAVE_DEBOUNCE_MS);
    }

    /* ===== Daten laden ===== */
    async function loadFolders(){
      const snap = await getDocs(collection(db,'folders'));
      folders = [];
      snap.forEach(d=> folders.push({ id:d.id, ...(d.data()||{}) }));
      folders.sort((a,b)=> (a.name||a.id).localeCompare(b.name||b.id));
    }
    async function loadProjects(){
      const snap = await getDocs(collection(db,'projects'));
      allProjects = [];
      snap.forEach(d=> allProjects.push({ id:d.id, ...(d.data()||{}) }));
      allProjects.sort((a,b)=> (a.name||a.id).localeCompare(b.name||b.id));
    }

    /* ===== Render Ordner ===== */
    function renderFolders(){
      folderList.innerHTML = '';
      // "Alle"-Pseudo-Ordner
      folderList.appendChild(folderRow({ id:null, name:'Alle' }, true));
      folders.forEach(f=> folderList.appendChild(folderRow(f)));
      highlightActiveFolder();
    }
    function folderRow(f, isAll=false){
      const li = document.createElement('li'); li.className='row'; li.dataset.fid = f.id ?? '';
      const btn = document.createElement('button'); btn.className='main'; btn.textContent = f.name;
      btn.onclick = ()=> { currentFolderId = f.id ?? null; renderProjects(); highlightActiveFolder(); };
      li.appendChild(btn);

      const icons = document.createElement('div'); icons.className='icons';
      if(!isAll){
        const rn = document.createElement('button'); rn.className='icon-btn'; rn.title='Umbenennen'; rn.textContent='‚úèÔ∏è';
        rn.onclick = async ()=>{
          const name = prompt('Ordner umbenennen:', f.name || '');
          if(!name) return;
          await setDoc(doc(db,'folders', f.id), { name }, { merge:true });
          await loadFolders(); renderFolders();
        };
        const del = document.createElement('button'); del.className='icon-btn'; del.title='L√∂schen'; del.textContent='üóëÔ∏è';
        del.onclick = async ()=>{
          const has = allProjects.some(p=> (p.folderId||null) === f.id);
          if(has){ alert('Ordner ist nicht leer. Verschiebe oder l√∂sche zuerst die Projekte.'); return; }
          if(!confirm(`Ordner "${f.name}" wirklich l√∂schen?`)) return;
          await deleteDoc(doc(db,'folders', f.id));
          await loadFolders(); renderFolders();
        };
        icons.appendChild(rn); icons.appendChild(del);
      }
      // Drop-Ziel f√ºr Projekte:
      li.ondragover = (e)=>{ e.preventDefault(); li.classList.add('droptarget'); };
      li.ondragleave = ()=> li.classList.remove('droptarget');
      li.ondrop = async (e)=>{
        e.preventDefault(); li.classList.remove('droptarget');
        const pid = e.dataTransfer.getData('text/projectId'); if(!pid) return;
        await setDoc(doc(db,'projects',pid), { folderId: f.id ?? null }, { merge:true });
        await loadProjects(); renderProjects();
      };
      li.appendChild(icons);
      return li;
    }
    function highlightActiveFolder(){
      document.querySelectorAll('#folderList .row').forEach(r=>{
        const fid = r.dataset.fid || null;
        r.classList.toggle('active', (fid=== (currentFolderId ?? null)));
      });
    }

    /* ===== Render Projekte ===== */
    function renderProjects(){
      projList.innerHTML = '';
      const list = allProjects.filter(p=> (currentFolderId==null ? true : (p.folderId||null)===currentFolderId));
      list.forEach(p=> projList.appendChild(projectRow(p)));
      // aktives Projekt highlighten
      document.querySelectorAll('#projList .row').forEach(r=>{
        r.classList.toggle('active', r.dataset.pid === (current?.id || ''));
      });
    }
    function projectRow(p){
      const li = document.createElement('li'); li.className='row'; li.dataset.pid = p.id;
      const btn = document.createElement('button'); btn.className='main'; btn.textContent = p.name || p.id;
      btn.onclick = ()=> openProject(p.id);
      btn.draggable = true;
      btn.ondragstart = (e)=> e.dataTransfer.setData('text/projectId', p.id);
      li.appendChild(btn);

      const icons = document.createElement('div'); icons.className='icons';
      const rn = document.createElement('button'); rn.className='icon-btn'; rn.title='Umbenennen'; rn.textContent='‚úèÔ∏è';
      rn.onclick = async ()=>{
        const name = prompt('Projekt umbenennen:', p.name || '');
        if(!name) return;
        await setDoc(doc(db,'projects', p.id), { name }, { merge:true });
        await loadProjects(); renderProjects(); if(current?.id===p.id){ current.name=name; titleEl.textContent=name; }
      };
      const del = document.createElement('button'); del.className='icon-btn'; del.title='L√∂schen'; del.textContent='üóëÔ∏è';
      del.onclick = async ()=>{
        if(!confirm(`Projekt "${p.name}" wirklich l√∂schen?`)) return;
        await deleteDoc(doc(db,'projects', p.id));
        if(current?.id===p.id){ current=null; boxes=[]; bgUrl=''; titleEl.textContent='Kein Projekt gew√§hlt'; bg.classList.add('hidden'); canvas.querySelectorAll('.box').forEach(b=>b.remove()); }
        await loadProjects(); renderProjects();
      };
      icons.appendChild(rn); icons.appendChild(del);
      li.appendChild(icons);
      return li;
    }

    /* ===== Neues Projekt / Ordner ===== */
    $('addBtn').onclick = async ()=>{
      const name = $('newName').value.trim(); if(!name) return;
      const id = slug(name);
      await setDoc(doc(db,'projects',id), {
        name, folderId: currentFolderId ?? null, bgUrl:'', boxes:[], updatedAt: Date.now()
      });
      $('newName').value = '';
      await loadProjects(); renderProjects(); openProject(id);
    };
    $('addFolderBtn').onclick = async ()=>{
      const name = $('newFolderName').value.trim(); if(!name) return;
      const id = slug(name);
      await setDoc(doc(db,'folders',id), { name, createdAt: Date.now() });
      $('newFolderName').value=''; await loadFolders(); renderFolders();
    };

    /* ===== Projekt √∂ffnen ===== */
    async function openProject(id){
      status('Lade Projekt‚Ä¶');
      const d = await getDoc(doc(db,'projects',id));
      if(!d.exists()){ status('Nicht gefunden'); return; }
      const data = d.data();
      current = { id, name:data.name||id, folderId: data.folderId||null };
      boxes = Array.isArray(data.boxes) ? data.boxes : [];
      bgUrl = data.bgUrl || '';
      titleEl.textContent = current.name;
      localStorage.setItem(LAST_KEY, id);

      // highlight in Liste
      document.querySelectorAll('#projList .row').forEach(r=>{
        r.classList.toggle('active', r.dataset.pid === id);
      });

      if(bgUrl){ bg.src = bgUrl; bg.classList.remove('hidden'); } else { bg.src=''; bg.classList.add('hidden'); }
      renderBoxes();
      status('Geladen');
    }

    /* ===== Boxen & Canvas ===== */
    function renderBoxes(){
      [...canvas.querySelectorAll('.box')].forEach(n=>n.remove());
      boxes.forEach(b=>{
        const div = document.createElement('div'); div.className='box'; div.dataset.id=b.id;
        div.style.left=b.x+'px'; div.style.top=b.y+'px'; div.style.width=b.w+'px'; div.style.height=b.h+'px';
        div.style.background=hexToRGBA(b.color||'#ffcc00',.25); div.style.borderColor=b.color||'#ffcc00';
        makeDraggableResizable(div, b.id); canvas.appendChild(div);
      });
    }

    $('bgBtn').onclick = ()=> fileInput.click();
    fileInput.onchange = async (e)=>{
      if(!current || !e.target.files?.length) return;
      const file = e.target.files[0]; status('Bild wird hochgeladen‚Ä¶');
      const r = ref(storage, `projects/${current.id}/background`);
      await uploadBytes(r, file); bgUrl = await getDownloadURL(r);
      bg.src = bgUrl; bg.classList.remove('hidden'); status('Bild bereit'); scheduleSave();
    };

    $('addBoxBtn').onclick = ()=>{
      if(!current) return;
      const id = 'b'+Math.random().toString(36).slice(2,8);
      const color = colorPicker.value || '#ffcc00';
      const box = { id, x:40+boxes.length*10, y:40+boxes.length*10, w:160, h:100, color };
      boxes.push(box); renderBoxes(); scheduleSave();
    };
    $('saveBtn').onclick = ()=> scheduleSave();

    function makeDraggableResizable(el, id){
      let mode=null, startX, startY, startW, startH, startL, startT;
      el.addEventListener('pointerdown', (e)=>{
        const rect = el.getBoundingClientRect(); const inResize = (rect.right-e.clientX<10)&&(rect.bottom-e.clientY<10);
        mode = inResize ? 'resize' : 'move';
        startX=e.clientX; startY=e.clientY; startW=rect.width; startH=rect.height;
        const c = canvas.getBoundingClientRect();
        startL = rect.left - c.left + canvas.scrollLeft; startT = rect.top - c.top + canvas.scrollTop;
        el.setPointerCapture(e.pointerId);
      });
      el.addEventListener('pointermove', (e)=>{
        if(!mode) return; const dx=e.clientX-startX, dy=e.clientY-startY;
        if(mode==='move'){ el.style.left=(startL+dx)+'px'; el.style.top=(startT+dy)+'px'; }
        else{ el.style.width=Math.max(40,startW+dx)+'px'; el.style.height=Math.max(30,startH+dy)+'px'; }
      });
      el.addEventListener('pointerup', ()=>{
        if(!mode) return;
        const r=el.getBoundingClientRect(), c=canvas.getBoundingClientRect(); const bx=boxes.find(b=>b.id===id);
        if(bx){ bx.x = r.left - c.left + canvas.scrollLeft; bx.y = r.top - c.top + canvas.scrollTop; bx.w = r.width; bx.h = r.height; }
        mode=null; scheduleSave();
      });
      el.addEventListener('dblclick', ()=>{
        boxes = boxes.filter(b=>b.id!==id); el.remove(); scheduleSave();
      });
    }

    /* ===== Start ===== */
    (async function init(){
      status('Lade‚Ä¶');
      await Promise.all([loadFolders(), loadProjects()]);
      renderFolders(); renderProjects();
      const last = localStorage.getItem(LAST_KEY);
      if(last){ openProject(last).catch(()=>{}); }
      status('Bereit');
    })();
  </script>
</body>
</html>
