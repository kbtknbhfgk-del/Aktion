<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Marktplan ‚Äì Editor (v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7f9; --ink:#111; --muted:#6b7280; --brand:#2563eb; --sel:#10b981; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink);background:var(--bg)}
    .app{display:grid;grid-template-columns:280px 1fr; height:100%}
    .side{padding:14px; border-right:1px solid #e5e7eb; background:#fff; overflow:auto}
    .side h2{margin:6px 0 8px;font-size:15px}
    .tools{display:grid; gap:8px}
    .row{display:flex; gap:8px; align-items:center}
    .btn{appearance:none;border:1px solid #e5e7eb; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:#d1d5db}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    input[type=file]{display:none}
    input[type=number]{width:90px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px}
    .palette{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .chip{padding:10px; border:1px dashed #d1d5db; background:#fafafa; border-radius:12px; text-align:center; cursor:grab; user-select:none}
    .chip:active{cursor:grabbing}
    .addchip{display:flex; gap:6px; margin-top:8px}
    .addchip input{flex:1;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
    .board-wrap {
  position: relative;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: center;
}

.board-wrap {
  position: relative;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 12px;

  /* Container-Queries aktivieren, damit wir die Gr√∂√üe des Wraps kennen */
  container-type: size;

  /* Skalierungsfaktor: Board passt sich an verf√ºgbaren Platz an */
  --s: min(
    calc((100cqw - 24px) / 1600),
    calc((100cqh - 24px) / 900),
    1
  );
}

.board {
  position: relative;
  width: 1600px;
  height: 900px;

  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 1px 6px rgba(0,0,0,.05);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;

  transform-origin: center center;
  transform: scale(var(--s));
}

    .grid{position:absolute; inset:0; background:
      linear-gradient(to right, rgba(0,0,0,.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0,0,0,.06) 1px, transparent 1px);
      background-size:40px 40px; pointer-events:none; border-radius:12px}
    .hidden{display:none}
    .item{position:absolute; min-width:90px; min-height:36px; padding:6px 10px; border:2px solid var(--brand); background:rgba(37,99,235,.08); border-radius:10px; cursor:move; user-select:none; display:flex; align-items:center; justify-content:center; transform-origin:center; touch-action:none}
    .item.selected{outline:2px solid var(--sel)}
    .resize{position:absolute; width:12px;height:12px;border-radius:3px;background:var(--brand);right:-7px;bottom:-7px; cursor:nwse-resize}
    .rotate{position:absolute; width:12px;height:12px;border-radius:50%;background:var(--brand);left:50%;top:-20px;transform:translateX(-50%);cursor:grab}
    .hint{position:absolute; inset:auto 12px 12px auto; background:rgba(255,255,255,.9); padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; color:#666}
    .kbd{font-family:ui-monospace, Menlo, monospace; background:#f1f5f9; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px}
    .toolbar{position:fixed; right:20px; top:20px; display:flex; gap:8px; align-items:center; background:#fff; border:1px solid #e5e7eb; padding:8px 10px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,.06)}
    .toolbar.hidden{display:none}
    .toolbar input[type=color]{border:1px solid #e5e7eb;border-radius:8px;width:36px;height:32px;padding:0}
    .summary{margin-top:10px; color:var(--muted); font-size:13px}
  </style>
</head>
<body>
<div class="app">
  <aside class="side">
    <h2>Marktplan</h2>
    <div class="tools">
      <label class="btn">üñºÔ∏è Hintergrund laden
        <input id="bgInput" type="file" accept="image/*">
      </label>
      <div class="row">
        <label class="btn ghost"><input id="gridToggle" type="checkbox"> Raster</label>
        <div class="row">Gr√∂√üe:<input id="gridSize" type="number" min="5" value="40">px</div>
        <label class="btn ghost"><input id="snapToggle" type="checkbox" checked> Snap</label>
      </div>
      <button id="clearBtn" class="btn">üßπ Alles l√∂schen</button>
    </div>

    <h2 style="margin-top:12px">Objekte</h2>
    <div class="palette" id="palette"></div>
    <div class="addchip">
      <input id="newChipText" placeholder="Neues Objekt (z.B. Tisch)">
      <button id="addChipBtn" class="btn">‚ûï</button>
    </div>

    <h2 style="margin-top:14px">Datei</h2>
    <div class="tools">
      <button id="saveJson" class="btn">üíæ Plan speichern (JSON)</button>
      <label class="btn">üìÇ Plan laden
        <input id="loadJson" type="file" accept="application/json">
      </label>
      <button id="exportPng" class="btn">üñºÔ∏è Export PNG</button>
      <button id="exportPdf" class="btn">üìÑ Export PDF (A4)</button>
      <button id="exportCsv" class="btn">üìë Export CSV (Z√§hlung)</button>
    </div>

    <div class="summary" id="summary">Z√§hlung: ‚Äì</div>

    <p style="margin-top:12px;color:#666">
      Doppelklick auf einen Kasten zum Umbenennen. Entfernen: Kasten anw√§hlen + <span class="kbd">Entf</span>.
    </p>
  </aside>

  <main class="board-wrap">
    <div id="board" class="board">
      <div id="grid" class="grid hidden"></div>
      <div class="hint">Hintergrund laden ‚Üí Objekt aus der Palette ziehen ‚Üí platzieren ‚Üî skalieren (Shift = schneller)</div>
    </div>
  </main>
</div>

<!-- Floating Toolbar (f√ºr ausgew√§hltes Item) -->
<div id="toolbar" class="toolbar hidden">
  <button id="dupBtn" class="btn">‚éò Duplizieren</button>
  <button id="delBtn" class="btn">üóëÔ∏è L√∂schen</button>
  <label class="row">Farbe <input id="colorPicker" type="color" value="#2563eb"></label>
  <label class="row">Drehung <input id="rotSlider" type="range" min="0" max="360" value="0"></label>
  <button id="frontBtn" class="btn">‚¨ÜÔ∏è Nach vorn</button>
  <button id="backBtn" class="btn">‚¨áÔ∏è Nach hinten</button>
</div>

<!-- libs f√ºr Export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
  const board = document.getElementById('board');
  const grid = document.getElementById('grid');
  const gridToggle = document.getElementById('gridToggle');
  const gridSizeInput = document.getElementById('gridSize');
  const snapToggle = document.getElementById('snapToggle');
  const palette = document.getElementById('palette');
  const summaryEl = document.getElementById('summary');
  const toolbar = document.getElementById('toolbar');
  const colorPicker = document.getElementById('colorPicker');
  const rotSlider = document.getElementById('rotSlider');
  const dupBtn = document.getElementById('dupBtn');
  const delBtn = document.getElementById('delBtn');
  const frontBtn = document.getElementById('frontBtn');
  const backBtn = document.getElementById('backBtn');


// ---- Fallback-Skalierung f√ºr Notion (wenn cqw/cqh nicht unterst√ºtzt) ----
(function(){
  const supportsContainerUnits = CSS && CSS.supports && CSS.supports('width: 100cqw');
  if (supportsContainerUnits) return; // Unser CSS reicht

  const wrap = document.querySelector('.board-wrap');
  const board = document.getElementById('board');

  function scaleFallback(){
    if (!wrap || !board) return;
    // Designgr√∂√üe des Boards: 1600 x 900
    const s = Math.min(
      (wrap.clientWidth - 24) / 1600,
      (wrap.clientHeight - 24) / 900,
      1
    );
    // setzt die gleiche CSS-Variable wie im Stylesheet
    wrap.style.setProperty('--s', s);
    board.style.transform = `scale(${s})`;
    board.style.transformOrigin = 'center center';
  }

  window.addEventListener('resize', scaleFallback, { passive: true });
  window.addEventListener('load', scaleFallback);
  // Falls Notion den Embed verz√∂gert rendert, nochmal nach kurzer Zeit
  setTimeout(scaleFallback, 300);
})();



  const DEFAULT_CHIPS = ['Tisch','Theke','Sp√ºle','Banner','K√ºhlung','Stromkasten'];

  let zCounter = 1;
  let selected = null;
  let currentBgDataUrl = null;
  let saveTimer = null;

  // ---- Palette ----
  function renderPalette() {
    palette.innerHTML = '';
    const chips = JSON.parse(localStorage.getItem('chips')||'[]');
    (chips.length ? chips : DEFAULT_CHIPS).forEach(label => addChip(label));
  }

  function addChip(label){
    const el = document.createElement('div');
    el.className = 'chip';
    el.textContent = label;
    el.dataset.label = label;
    el.setAttribute('draggable','true');
    el.addEventListener('dragstart', ev=> ev.dataTransfer.setData('text/plain', label));
    palette.appendChild(el);
  }

  document.getElementById('addChipBtn').onclick = () => {
    const v = document.getElementById('newChipText').value.trim();
    if(!v) return;
    const chips = new Set(JSON.parse(localStorage.getItem('chips')||'[]'));
    chips.add(v);
    localStorage.setItem('chips', JSON.stringify([...chips]));
    document.getElementById('newChipText').value='';
    renderPalette();
  };

  renderPalette();

  // ---- Hintergrund laden (als DataURL, damit im JSON mitgespeichert) ----
  document.getElementById('bgInput').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      currentBgDataUrl = reader.result;
      board.style.backgroundImage = `url("${currentBgDataUrl}")`;
      autosave();
    };
    reader.readAsDataURL(file);
  });

  // ---- Grid + Snap ----
  function updateGrid(){
    const size = Math.max(5, parseInt(gridSizeInput.value)||40);
    grid.style.backgroundSize = size+'px '+size+'px';
  }
  gridToggle.addEventListener('change', ()=>{
    grid.classList.toggle('hidden', !gridToggle.checked);
    autosave();
  });
  gridSizeInput.addEventListener('input', ()=>{ updateGrid(); autosave(); });
  updateGrid();

  // ---- Drop-Ziel ----
  board.addEventListener('dragover', ev=>ev.preventDefault());
  board.addEventListener('drop', ev=>{
    ev.preventDefault();
    const label = ev.dataTransfer.getData('text/plain') || 'Objekt';
    const rect = board.getBoundingClientRect();
    const x = ev.clientX - rect.left - 60, y = ev.clientY - rect.top - 20;
    const it = createItem(label, x, y);
    select(it);
  });

  // ---- Item erstellen ----
  function createItem(text, x=40, y=40, w=120, h=44, rot=0, color='#2563eb', z=++zCounter){
    const el = document.createElement('div');
    el.className = 'item';
    el.style.left = px(snap(x));
    el.style.top = px(snap(y));
    el.style.width = px(w);
    el.style.height = px(h);
    el.style.borderColor = color;
    el.style.backgroundColor = hexToRgba(color, 0.12);
    el.style.transform = `rotate(${rot}deg)`;
    el.style.zIndex = z;
    el.dataset.color = color;
    el.dataset.rot = rot;
    el.textContent = text;

    // Handles
    const r = document.createElement('div'); r.className='resize'; el.appendChild(r);
    const rotH = document.createElement('div'); rotH.className='rotate'; el.appendChild(rotH);

    // Auswahl
    el.addEventListener('pointerdown', e=>{
      if(e.target===r || e.target===rotH) return;
      beginDrag(el, e);
      select(el);
    });

    // Doppelklick rename
    el.addEventListener('dblclick', ()=>{
      el.setAttribute('contenteditable','true'); el.focus();
      const sel=window.getSelection(); const range=document.createRange();
      range.selectNodeContents(el); sel.removeAllRanges(); sel.addRange(range);
    });
    el.addEventListener('blur', ()=>{ el.removeAttribute('contenteditable'); autosave(); updateSummary(); });

    // Entfernen
    el.addEventListener('keydown', e=>{ if(e.key==='Delete'){ if(selected===el) select(null); el.remove(); autosave(); updateSummary(); } });

    // Resize
    setupResize(el, r);

    // Rotate
    setupRotate(el, rotH);

    board.appendChild(el);
    updateSummary();
    autosave();
    return el;
  }

  // ---- Drag bewegen ----
  function beginDrag(el, e){
    let dragging=true, rx=e.clientX - el.offsetLeft, ry=e.clientY - el.offsetTop;
    el.setPointerCapture(e.pointerId);
    const mm = (ev)=>{
      if(!dragging) return;
      const x = ev.clientX - rx, y = ev.clientY - ry;
      el.style.left = px(snap(clamp(x,0,board.clientWidth - el.offsetWidth)));
      el.style.top  = px(snap(clamp(y,0,board.clientHeight- el.offsetHeight)));
    };
    const up = ()=>{
      dragging=false;
      el.removeEventListener('pointermove', mm);
      el.removeEventListener('pointerup', up);
      autosave();
    };
    el.addEventListener('pointermove', mm);
    el.addEventListener('pointerup', up);
  }

  function setupResize(el, handle){
    let resizing=false, rw=0, rh=0, sx=0, sy=0;
    handle.addEventListener('pointerdown', e=>{
      e.stopPropagation(); resizing=true; sx=e.clientX; sy=e.clientY; rw=el.offsetWidth; rh=el.offsetHeight;
      handle.setPointerCapture(e.pointerId);
    });
    handle.addEventListener('pointermove', e=>{
      if(!resizing) return;
      let nw = rw + (e.clientX - sx), nh = rh + (e.clientY - sy);
      nw = Math.max(70, nw); nh = Math.max(32, nh);
      el.style.width  = px(snap(nw));
      el.style.height = px(snap(nh));
    });
    handle.addEventListener('pointerup', ()=>{ resizing=false; autosave(); });
  }

  function setupRotate(el, handle){
    let rotating=false, cx=0, cy=0;
    handle.addEventListener('pointerdown', e=>{
      e.stopPropagation(); rotating=true; const rect = el.getBoundingClientRect(); cx = rect.left + rect.width/2; cy = rect.top + rect.height/2;
      handle.setPointerCapture(e.pointerId);
    });
    handle.addEventListener('pointermove', e=>{
      if(!rotating) return;
      const ang = Math.atan2(e.clientY - cy, e.clientX - cx) * 180/Math.PI + 90;
      const rot = Math.round(ang);
      el.dataset.rot = rot;
      el.style.transform = `rotate(${rot}deg)`;
      if(selected===el) rotSlider.value = String((rot+360)%360);
    });
    handle.addEventListener('pointerup', ()=>{ rotating=false; autosave(); });
  }

  // ---- Auswahl / Toolbar ----
  function select(el){
    if(selected) selected.classList.remove('selected');
    selected = el;
    if(selected){
      selected.classList.add('selected');
      toolbar.classList.remove('hidden');
      colorPicker.value = selected.dataset.color || '#2563eb';
      rotSlider.value = String((parseInt(selected.dataset.rot)||0 + 360) % 360);
      selected.focus();
    }else{
      toolbar.classList.add('hidden');
    }
  }

  board.addEventListener('pointerdown', (e)=>{ if(e.target===board || e.target===grid){ select(null); } });

  colorPicker.addEventListener('input', ()=>{
    if(!selected) return;
    const color = colorPicker.value;
    selected.dataset.color = color;
    selected.style.borderColor = color;
    selected.style.backgroundColor = hexToRgba(color, 0.12);
    autosave();
  });

  rotSlider.addEventListener('input', ()=>{
    if(!selected) return;
    const rot = parseInt(rotSlider.value)||0;
    selected.dataset.rot = rot;
    selected.style.transform = `rotate(${rot}deg)`;
    autosave();
  });

  dupBtn.onclick = ()=>{
    if(!selected) return;
    const it = createItem(selected.textContent, parseInt(selected.style.left)+20, parseInt(selected.style.top)+20,
                          parseInt(selected.style.width), parseInt(selected.style.height),
                          parseInt(selected.dataset.rot)||0, selected.dataset.color||'#2563eb', ++zCounter);
    select(it);
  };

  delBtn.onclick = ()=>{ if(selected){ const n=selected; select(null); n.remove(); autosave(); updateSummary(); } };
  frontBtn.onclick = ()=>{ if(selected){ selected.style.zIndex = ++zCounter; autosave(); } };
  backBtn.onclick = ()=>{ if(selected){ selected.style.zIndex = 0; autosave(); } };

  // ---- Utils ----
  function px(n){ return `${Math.round(n)}px`; }
  function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }
  function snap(v){
    if(!snapToggle.checked) return v;
    const s = Math.max(5, parseInt(gridSizeInput.value)||40);
    return Math.round(v/s)*s;
  }
  function hexToRgba(hex, a){
    const m = hex.replace('#','');
    const bigint = parseInt(m.length===3 ? m.split('').map(c=>c+c).join('') : m, 16);
    const r = (bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
    return `rgba(${r},${g},${b},${a})`;
  }

  // ---- Clear ----
  document.getElementById('clearBtn').onclick = ()=>{
    [...board.querySelectorAll('.item')].forEach(n=>n.remove());
    board.style.backgroundImage = 'none';
    currentBgDataUrl = null;
    select(null);
    autosave();
    updateSummary();
  };

  // ---- Save / Load JSON ----
  document.getElementById('saveJson').onclick = ()=>{
    const data = serialize();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'arktplan.json'});
    a.click();
  };

  document.getElementById('loadJson').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text(); const data = JSON.parse(text);
    deserialize(data);
    autosave();
  });

  function serialize(){
    return {
      bg: currentBgDataUrl,
      gridVisible: !grid.classList.contains('hidden'),
      gridSize: Math.max(5, parseInt(gridSizeInput.value)||40),
      snap: snapToggle.checked,
      items: [...board.querySelectorAll('.item')].map(el=>({
        text: el.textContent,
        x: parseInt(el.style.left), y: parseInt(el.style.top),
        w: parseInt(el.style.width), h: parseInt(el.style.height),
        rot: parseInt(el.dataset.rot)||0,
        color: el.dataset.color||'#2563eb',
        z: parseInt(el.style.zIndex)||1
      }))
    };
  }

  function deserialize(data){
    [...board.querySelectorAll('.item')].forEach(n=>n.remove());
    currentBgDataUrl = data.bg || null;
    board.style.backgroundImage = currentBgDataUrl ? `url("${currentBgDataUrl}")` : 'none';
    grid.classList.toggle('hidden', data.gridVisible===false);
    gridToggle.checked = data.gridVisible!==false;
    gridSizeInput.value = data.gridSize || 40; updateGrid();
    snapToggle.checked = data.snap!==false;
    (data.items||[]).forEach(it=>{
      createItem(it.text, it.x, it.y, it.w, it.h, it.rot||0, it.color||'#2563eb', it.z||1);
    });
    updateSummary();
  }

  // ---- Autosave (localStorage) ----
  function autosave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      localStorage.setItem('marktplan_autosave', JSON.stringify(serialize()));
    }, 250);
  }
  try{
    const saved = localStorage.getItem('marktplan_autosave');
    if(saved){
      deserialize(JSON.parse(saved));
    }
  }catch(e){}

  // ---- Export PNG ----
  document.getElementById('exportPng').onclick = async ()=>{
    const canvas = await html2canvas(board, {backgroundColor:'#ffffff', scale:2});
    canvas.toBlob(blob=>{
      const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'marktplan.png'});
      a.click();
    });
  };

  // ---- Export PDF A4 ----
  document.getElementById('exportPdf').onclick = async ()=>{
    const canvas = await html2canvas(board, {backgroundColor:'#ffffff', scale:2});
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'mm', format:'a4', orientation:'landscape'});
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(pageW / canvas.width, pageH / canvas.height);
    const w = canvas.width * ratio * 0.264583;
    const h = canvas.height * ratio * 0.264583;
    const x = (pageW - w)/2, y=(pageH - h)/2;
    pdf.addImage(img, 'PNG', x, y, w, h);
    pdf.save('marktplan.pdf');
  };

  // ---- Export CSV (Z√§hlung) ----
  document.getElementById('exportCsv').onclick = ()=>{
    const counts = getCounts();
    const rows = [['Label','Anzahl']].concat(Object.entries(counts));
    const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'marktplan_counts.csv'});
    a.click();
  };

  function getCounts(){
    const counts = {};
    [...board.querySelectorAll('.item')].forEach(el=>{
      const key = (el.textContent||'Objekt').trim();
      counts[key] = (counts[key]||0)+1;
    });
    return counts;
  }

  function updateSummary(){
    const c = getCounts();
    const entries = Object.entries(c);
    summaryEl.textContent = entries.length ? ('Z√§hlung: ' + entries.map(([k,v])=>`${k} ${v}`).join(' ¬∑ ')) : 'Z√§hlung: ‚Äì';
  }

  // ---- Tastatur: Pfeile & Shortcuts ----
  document.addEventListener('keydown', (e)=>{
    if(!selected) return;
    const step = e.shiftKey ? 10 : 1;
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      e.preventDefault();
      const x = parseInt(selected.style.left), y = parseInt(selected.style.top);
      if(e.key==='ArrowLeft') selected.style.left = px(snap(x-step));
      if(e.key==='ArrowRight') selected.style.left = px(snap(x+step));
      if(e.key==='ArrowUp') selected.style.top = px(snap(y-step));
      if(e.key==='ArrowDown') selected.style.top = px(snap(y+step));
      autosave();
    }
    if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='d'){ e.preventDefault(); dupBtn.click(); }
    if(e.key==='Delete'){ e.preventDefault(); delBtn.click(); }
    if((e.metaKey||e.ctrlKey) && e.key===']'){ e.preventDefault(); frontBtn.click(); }
    if((e.metaKey||e.ctrlKey) && e.key==='['){ e.preventDefault(); backBtn.click(); }
  });
</script>
</body>
</html>
